<!-- Messages Modal -->
<!-- Modal -->
<div
	class="modal fade"
	id="messagesModal"
	tabindex="-1"
	role="dialog"
	aria-labelledby="modalTitleId"
	aria-hidden="true"
>
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="modalTitleId">
					<span
						data-uk-icon="icon: comments"
						class="uk-margin-small-right"
					></span
					>Messages
				</h5>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"
					aria-label="Close"
				></button>
			</div>
			<div class="modal-body">
				<div class="container-fluid" id="messagesContainer">
					<!-- Messages will be dynamically loaded here -->
					<div class="uk-text-center uk-text-muted uk-padding" id="noMessagesPlaceholder">
						<p>Loading messages...</p>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
					Close
				</button>
				
				<!-- Dynamic Mark All As Read Button -->
				<button type="button" class="btn btn-primary" id="markAllAsReadBtn" onclick="markAllMessagesAsRead()" style="display: none;">
					Mark All As Read
					<i data-uk-icon="icon: check"></i>
				</button>
				
				<button type="button" class="btn btn-info disabled" id="noNewMessagesBtn">
					No New Messages
					<i data-uk-icon="icon: check"></i>
				</button>
				
				<!-- Dynamic Delete All Button -->
				<button type="button" class="btn btn-danger" id="deleteAllMessagesBtn" onclick="deleteAllMessages()" style="display: none;">
					Delete All
					<i data-uk-icon="icon: trash"></i>
				</button>
			</div>
		</div>
	</div>
</div>

<script>
	// Include the messages.js script
	const messagesScript = document.createElement('script');
	messagesScript.src = '/js/messages.js';
	document.head.appendChild(messagesScript);

	var messagesModal = document.getElementById("messagesModal");

	// Pass server messages data to the MessageManager
	window.serverMessages = [
		<% if (user.messages && user.messages.length > 0) { %>
			<% user.messages.forEach((message, index) => { %>
				{
					id: '<%= message._id || message.id %>',
					title: '<%= message.title %>',
					read: <%= message.read %>,
					createdAt: '<%= message.createdAt %>'
				}<%= index < user.messages.length - 1 ? ',' : '' %>
			<% }); %>
		<% } %>
	];

	messagesModal.addEventListener("show.bs.modal", function (event) {
		// Button that triggered the modal
		let button = event.relatedTarget;
		// Extract info from data-bs-* attributes
		let recipient = button.getAttribute("data-bs-whatever");

		// Initialize message manager if not already done
		if (window.messageManager) {
			window.messageManager.updateMessageCount();
		}
	});

	// Dynamic message functions
	function markAllMessagesAsRead() {
		if (window.MessageManager) {
			window.MessageManager.markAllAsRead();
			
			// Send request to server to mark as read (optional - for persistence)
			const userId = '<%= user._id %>';
			const userType = '<%= theUserType %>';
			
			fetch(`/${userType}/messages/markasread/${userId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			}).catch(error => console.log('Mark as read request failed:', error));
		}
	}

	function deleteAllMessages() {
		if (window.MessageManager) {
			window.MessageManager.clearAll();
			
			// Send request to server to delete messages (optional - for persistence)
			const userId = '<%= user._id %>';
			const userType = '<%= theUserType %>';
			
			fetch(`/${userType}/messages/delete/${userId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				}
			}).then(response => {
				if (response.ok) {
					console.log('All messages deleted from server');
				}
			}).catch(error => {
				console.log('Delete all messages request failed:', error);
			});
		}
	}

	// Initialize message count on page load
	document.addEventListener('DOMContentLoaded', function() {
		setTimeout(() => {
			if (window.messageManager) {
				window.messageManager.updateMessageCount();
			}
		}, 1000);
	});
</script>
